import{d as e,r as a,b as l,o as n,k as t,n as c,N as i,R as o,c as s,e as u,f as d,g as r,h as m,w as p,j as v,V as h,t as g,z as y,F as _,q as f,p as k,l as C,_ as x}from"./index-fb5e286d.js";const w={class:"channels-page"},b={class:"toolbar"},V={class:"toolbar-left"},$={class:"toolbar-right"},S={class:"table-container"},U=["checked"],Y=["checked","onChange"],j={class:"channel-link"},A=["onClick","title"],T={key:0,class:"sync-time"},D={key:1,class:"no-sync-time"},M={style:{padding:"20px"}},X={style:{padding:"20px"}},F={style:{padding:"20px"}},R={style:{padding:"20px"}},z={style:{padding:"20px"}},E={class:"batch-create-hint"},I=(e=>(k("data-v-c36664b5"),e=e(),C(),e))((()=>r("span",null,"每行一个成员姓名,系统将自动为每个企微生成唯一的短链和落地页",-1))),O={style:{padding:"20px"}},W={style:{padding:"20px"}},q={class:"copy-actions"},H={class:"channel-info-list"},K={class:"channel-name"},L={class:"channel-url"},N={style:{padding:"20px"}},B=x(e({__name:"index",setup(e){const k=a(!1),C=a([]),x=a([]),B=a(""),G=a(""),J=a([]),P=a([]),Q=a([]),Z=a(null),ee=e=>{Z.value=e},ae=l({current:1,limit:20,total:0}),le=[{title:"选择",key:"checkbox",customSlot:"checkbox",titleSlot:"checkbox-header",width:"60px",align:"center"},{title:"成员姓名",key:"channel_name",customSlot:"channel_name",width:"150px"},{title:"所属部门",key:"description",width:"200px"},{title:"投诉链接配置",key:"complaint_config",customSlot:"complaint_config",width:"120px",align:"center"},{title:"同步时间",key:"sync_time",customSlot:"sync_time",width:"150px",align:"center"},{title:"投诉链接",key:"channel_url",customSlot:"channel_link",minWidth:"350px"},{title:"操作",customSlot:"operator",width:"100px",align:"center"}],ne=a(!1),te=a(!1),ce=l({channel_name:"",description:""}),ie=a(),oe=a(!1),se=a(!1),ue=l({id:null,channel_name:"",description:"",status:"enabled"}),de=a(),re=a(!1),me=a(!1),pe=l({channel_names:""}),ve=a(!1),he=a(!1);n((()=>{document.title="企微管理",ge()}));const ge=async()=>{try{k.value=!0;const e={page:ae.current,pageSize:ae.limit,keyword:B.value};G.value&&(e.complaintConfig=G.value),J.value&&2===J.value.length&&(e.syncTimeStart=J.value[0],e.syncTimeEnd=J.value[1]);const a=await t.getChannels(e);C.value=a.list,ae.total=a.total}catch(e){c.msg("加载企微列表失败: "+e.message,{icon:2})}finally{k.value=!1}},ye=()=>{ae.current=1,P.value=[],Q.value=[],ge()},_e=()=>{B.value="",G.value="",J.value=[],ae.current=1,P.value=[],Q.value=[],ge()},fe=i((()=>C.value.length>0&&C.value.every((e=>P.value.includes(e.id))))),ke=i((()=>{const e=C.value.filter((e=>P.value.includes(e.id))).length;return e>0&&e<C.value.length}));o([ke,fe],(([e,a])=>{Z.value&&(Z.value.indeterminate=e&&!a)}));const Ce=e=>{e.target.checked?C.value.forEach((e=>{P.value.includes(e.id)||(P.value.push(e.id),Q.value.push(e))})):C.value.forEach((e=>{const a=P.value.indexOf(e.id);if(a>-1){P.value.splice(a,1);const l=Q.value.findIndex((a=>a.id===e.id));l>-1&&Q.value.splice(l,1)}}))},xe=()=>{if(0===Q.value.length)return void c.msg("请先选择要删除的企微",{icon:2});const e=Q.value.map((e=>e.channel_name)).join("、");c.confirm(`确定要删除选中的 ${Q.value.length} 个企微吗？\n\n删除的企微：${e}`,{yes:async()=>{try{const e=Q.value.map((e=>e.id));await t.batchDeleteChannels(e),c.msg(`成功删除 ${Q.value.length} 个企微`,{icon:1}),c.closeAll(),P.value=[],Q.value=[],ge()}catch(e){c.msg("批量删除失败: "+e.message,{icon:2})}}})},we=({current:e,limit:a})=>{ae.current=e,ae.limit=a,ge()},be=async()=>{try{if(!ce.channel_name)return void c.msg("请输入成员姓名",{icon:2});te.value=!0;await t.createChannel({channel_name:ce.channel_name,description:ce.description});c.msg("创建成功",{icon:1}),ne.value=!1,ge()}catch(e){c.msg("创建失败: "+e.message,{icon:2})}finally{te.value=!1}},Ve=async()=>{try{if(!ue.channel_name)return void c.msg("请输入成员姓名",{icon:2});se.value=!0;await t.updateChannel(ue.id,{channel_name:ue.channel_name,description:ue.description,status:ue.status});c.msg("更新成功",{icon:1}),oe.value=!1,ge()}catch(e){c.msg("更新失败: "+e.message,{icon:2})}finally{se.value=!1}},$e=e=>{if(!e)return"";const a=new Date(e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`},Se=async()=>{try{he.value=!0,c.msg("正在同步企微通讯录...",{icon:16,time:0});const e=await t.syncWechatContacts();c.closeAll();const a=e.summary||{},l=e.channelCreation||{};let n=`同步成功！\n部门数: ${a.departmentCount||0}, 成员数: ${a.userCount||0}`;void 0!==l.createdCount&&(n+=`\n企微创建: 新建 ${l.createdCount} 个, 跳过 ${l.skippedCount} 个`,l.errorCount>0&&(n+=`, 失败 ${l.errorCount} 个`)),n+='\n\n💡 请勾选成员后，点击"更新投诉链接"按钮设置投诉链接',c.msg(n,{icon:1,time:5e3}),l&&l.errorCount,ge()}catch(e){c.closeAll();let a="同步失败";e.message&&(a=e.message),a.includes("corpId")?c.msg(a,{icon:0,time:5e3}):c.msg(a,{icon:2})}finally{he.value=!1}},Ue=async()=>{try{if(!pe.channel_names.trim())return void c.msg("请输入成员姓名",{icon:2});me.value=!0;const e=pe.channel_names.split("\n").map((e=>e.trim())).filter((e=>e));if(0===e.length)return void c.msg("请输入有效的成员姓名",{icon:2});const a=(await t.batchCreateChannels({channel_names:e})).created.length;c.msg(`成功创建${a}个企微`,{icon:1}),re.value=!1,ge()}catch(e){c.msg("批量创建失败: "+e.message,{icon:2})}finally{me.value=!1}},Ye=async()=>{try{const e=x.value.map(((e,a)=>`${a+1}. ${e.channel_name}\n${e.channel_url}`)).join("\n\n");await navigator.clipboard.writeText(e),c.msg("已复制全部企微信息",{icon:1})}catch(e){c.msg("复制失败",{icon:2})}},je=async()=>{try{const e=x.value.map(((e,a)=>`${a+1}. ${e.channel_name}`)).join("\n");await navigator.clipboard.writeText(e),c.msg("已复制成员姓名",{icon:1})}catch(e){c.msg("复制失败",{icon:2})}},Ae=async()=>{try{const e=x.value.map(((e,a)=>`${a+1}. ${e.channel_url}`)).join("\n");await navigator.clipboard.writeText(e),c.msg("已复制企微链接",{icon:1})}catch(e){c.msg("复制失败",{icon:2})}},Te=()=>{if(0===Q.value.length)return void c.msg("请先选择要更新的企微",{icon:2});const e=Q.value.map((e=>e.channel_name)).join("、");c.confirm(`确定要为选中的 ${Q.value.length} 个企微更新投诉链接吗？\n\n${e}\n\n这将更新成员的企微扩展属性，设置投诉链接。`,{yes:async()=>{try{const e=Q.value.map((e=>e.id));c.msg("正在更新投诉链接...",{icon:16,time:0});const a=await t.updateComplaintChannels(e);c.closeAll();const l=a.success.length,n=a.skipped?a.skipped.length:0,i=a.failed.length;let o=`更新完成！\n成功: ${l}`;n>0&&(o+=`, 跳过: ${n}（已有投诉链接）`),i>0&&(o+=`, 失败: ${i}`),c.msg(o,{icon:1,time:3e3}),P.value=[],Q.value=[],ge()}catch(e){c.closeAll(),c.msg("更新失败: "+e.message,{icon:2})}}})},De=()=>{if(0===Q.value.length)return void c.msg("请先选择要清理的企微",{icon:2});const e=Q.value.map((e=>e.channel_name)).join("、");c.confirm(`确定要清理选中的 ${Q.value.length} 个企微的投诉链接吗？\n\n${e}\n\n这将清空成员的企微扩展属性中的投诉链接。`,{yes:async()=>{try{const e=Q.value.map((e=>e.id));c.msg("正在清理投诉链接...",{icon:16,time:0});const a=await t.clearComplaintChannels(e);c.closeAll();const l=a.success.length,n=a.skipped?a.skipped.length:0,i=a.failed.length;let o=`清理完成！\n成功: ${l}`;n>0&&(o+=`, 跳过: ${n}（链接URL已为空）`),i>0&&(o+=`, 失败: ${i}`),c.msg(o,{icon:1,time:3e3}),P.value=[],Q.value=[],ge()}catch(e){c.closeAll(),c.msg("清理失败: "+e.message,{icon:2})}}})};return(e,a)=>{const l=s("lay-icon"),n=s("lay-input"),i=s("lay-select-option"),o=s("lay-select"),Z=s("lay-date-picker"),ke=s("lay-button"),Me=s("lay-tag"),Xe=s("lay-table"),Fe=s("lay-form-item"),Re=s("lay-form"),ze=s("lay-layer"),Ee=s("lay-textarea");return u(),d("div",w,[r("div",b,[r("div",V,[m(n,{modelValue:B.value,"onUpdate:modelValue":a[0]||(a[0]=e=>B.value=e),placeholder:"请输入成员姓名搜索","allow-clear":"",style:{width:"250px"}},{suffix:p((()=>[m(l,{type:"layui-icon-search"})])),_:1},8,["modelValue"]),m(o,{modelValue:G.value,"onUpdate:modelValue":a[1]||(a[1]=e=>G.value=e),placeholder:"投诉链接配置",style:{width:"140px"},"allow-clear":""},{default:p((()=>[m(i,{value:"configured"},{default:p((()=>[v("已配置")])),_:1}),m(i,{value:"unconfigured"},{default:p((()=>[v("未配置")])),_:1})])),_:1},8,["modelValue"]),m(Z,{modelValue:J.value,"onUpdate:modelValue":a[2]||(a[2]=e=>J.value=e),type:"date",range:"",placeholder:"同步时间范围",style:{width:"350px"},format:"YYYY-MM-DD","value-format":"YYYY-MM-DD","allow-clear":""},null,8,["modelValue"]),m(ke,{onClick:ye},{default:p((()=>[v("搜索")])),_:1}),m(ke,{onClick:_e},{default:p((()=>[v("重置")])),_:1})]),r("div",$,[Q.value.length>0?(u(),h(ke,{key:0,type:"danger",onClick:xe},{default:p((()=>[v(" 批量删除 ("+g(Q.value.length)+") ",1)])),_:1})):y("",!0),m(ke,{type:"normal",disabled:0===Q.value.length,onClick:De},{default:p((()=>[v(" 清理投诉链接 "+g(Q.value.length>0?`(${Q.value.length})`:""),1)])),_:1},8,["disabled"]),m(ke,{type:"primary",disabled:0===Q.value.length,onClick:Te},{default:p((()=>[v(" 更新投诉链接 "+g(Q.value.length>0?`(${Q.value.length})`:""),1)])),_:1},8,["disabled"]),m(ke,{type:"warm",onClick:Se,loading:he.value},{default:p((()=>[v(" 同步企微通讯录 ")])),_:1},8,["loading"])])]),r("div",S,[m(Xe,{columns:le,"data-source":C.value,loading:k.value,page:ae,onChange:we,"selected-keys":P.value,"onUpdate:selectedKeys":a[3]||(a[3]=e=>P.value=e)},{"checkbox-header":p((()=>[r("input",{type:"checkbox",ref:ee,checked:fe.value,onChange:Ce},null,40,U)])),checkbox:p((({row:e})=>[r("input",{type:"checkbox",checked:P.value.includes(e.id),onChange:a=>((e,a)=>{if(a)P.value.includes(e.id)||(P.value.push(e.id),Q.value.push(e));else{const a=P.value.indexOf(e.id);a>-1&&(P.value.splice(a,1),Q.value.splice(a,1))}})(e,a.target.checked)},null,40,Y)])),channel_name:p((({row:e})=>[v(g(null==e?void 0:e.channel_name),1)])),channel_link:p((({row:e})=>[r("div",j,[r("span",{class:"link-text clickable",onClick:a=>(async e=>{try{await navigator.clipboard.writeText(e),c.msg("已复制到剪贴板",{icon:1})}catch(a){c.msg("复制失败",{icon:2})}})(e.channel_url),title:e.channel_url},g(e.channel_url),9,A)])])),complaint_config:p((({row:e})=>[m(Me,{type:e.channel_url&&""!==e.channel_url.trim()?"normal":"warm"},{default:p((()=>[v(g(e.channel_url&&""!==e.channel_url.trim()?"已配置":"未配置"),1)])),_:2},1032,["type"])])),sync_time:p((({row:e})=>[e.syncTime?(u(),d("span",T,g($e(e.syncTime)),1)):(u(),d("span",D,"未同步"))])),operator:p((({row:e})=>[m(ke,{size:"xs",type:"danger",onClick:a=>(async e=>{c.confirm(`确定要删除企微"${e.channel_name}"吗？`,{yes:async()=>{try{await t.deleteChannel(e.id),c.msg("删除成功",{icon:1}),c.closeAll(),ge()}catch(a){c.msg("删除失败: "+a.message,{icon:2})}}})})(e)},{default:p((()=>[v("删除")])),_:2},1032,["onClick"])])),_:1},8,["data-source","loading","page","selected-keys"])]),m(ze,{modelValue:ne.value,"onUpdate:modelValue":a[6]||(a[6]=e=>ne.value=e),title:"新建企微",area:["500px","auto"]},{footer:p((()=>[r("div",X,[m(ke,{onClick:a[5]||(a[5]=e=>ne.value=!1)},{default:p((()=>[v("取消")])),_:1}),m(ke,{type:"primary",onClick:be,loading:te.value},{default:p((()=>[v(" 创建 ")])),_:1},8,["loading"])])])),default:p((()=>[r("div",M,[m(Re,{model:ce,ref_key:"createFormRef",ref:ie},{default:p((()=>[m(Fe,{label:"成员姓名",prop:"channel_name"},{default:p((()=>[m(n,{modelValue:ce.channel_name,"onUpdate:modelValue":a[4]||(a[4]=e=>ce.channel_name=e),placeholder:"请输入成员姓名"},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])])),_:1},8,["modelValue"]),m(ze,{modelValue:oe.value,"onUpdate:modelValue":a[10]||(a[10]=e=>oe.value=e),title:"编辑企微",area:["500px","auto"]},{footer:p((()=>[r("div",R,[m(ke,{onClick:a[9]||(a[9]=e=>oe.value=!1)},{default:p((()=>[v("取消")])),_:1}),m(ke,{type:"primary",onClick:Ve,loading:se.value},{default:p((()=>[v(" 保存 ")])),_:1},8,["loading"])])])),default:p((()=>[r("div",F,[m(Re,{model:ue,ref_key:"editFormRef",ref:de},{default:p((()=>[m(Fe,{label:"成员姓名",prop:"channel_name"},{default:p((()=>[m(n,{modelValue:ue.channel_name,"onUpdate:modelValue":a[7]||(a[7]=e=>ue.channel_name=e),placeholder:"请输入成员姓名"},null,8,["modelValue"])])),_:1}),m(Fe,{label:"状态"},{default:p((()=>[m(o,{modelValue:ue.status,"onUpdate:modelValue":a[8]||(a[8]=e=>ue.status=e),placeholder:"请选择状态"},{default:p((()=>[m(i,{value:"enabled"},{default:p((()=>[v("启用")])),_:1}),m(i,{value:"disabled"},{default:p((()=>[v("禁用")])),_:1})])),_:1},8,["modelValue"])])),_:1})])),_:1},8,["model"])])])),_:1},8,["modelValue"]),m(ze,{modelValue:re.value,"onUpdate:modelValue":a[13]||(a[13]=e=>re.value=e),title:"批量创建企微",area:["600px","auto"]},{footer:p((()=>[r("div",O,[m(ke,{onClick:a[12]||(a[12]=e=>re.value=!1)},{default:p((()=>[v("取消")])),_:1}),m(ke,{type:"primary",onClick:Ue,loading:me.value},{default:p((()=>[v(" 批量创建 ")])),_:1},8,["loading"])])])),default:p((()=>[r("div",z,[m(Fe,{label:"成员姓名列表"},{default:p((()=>[m(Ee,{modelValue:pe.channel_names,"onUpdate:modelValue":a[11]||(a[11]=e=>pe.channel_names=e),rows:8,placeholder:"请输入成员姓名,一行一个:\nXX员工姓名1\nXX员工姓名2\nXX员工姓名3"},null,8,["modelValue"])])),_:1}),r("div",E,[m(l,{type:"layui-icon-tips"}),I])])])),_:1},8,["modelValue"]),m(ze,{modelValue:ve.value,"onUpdate:modelValue":a[15]||(a[15]=e=>ve.value=e),title:"批量复制企微信息",area:["600px","500px"]},{footer:p((()=>[r("div",N,[m(ke,{onClick:a[14]||(a[14]=e=>ve.value=!1)},{default:p((()=>[v("关闭")])),_:1})])])),default:p((()=>[r("div",W,[r("div",q,[m(ke,{type:"primary",onClick:Ye},{default:p((()=>[m(l,{type:"layui-icon-file"}),v(" 复制全部企微信息 ")])),_:1}),m(ke,{type:"normal",onClick:je},{default:p((()=>[m(l,{type:"layui-icon-edit"}),v(" 只复制名称 ")])),_:1}),m(ke,{type:"warm",onClick:Ae},{default:p((()=>[m(l,{type:"layui-icon-link"}),v(" 只复制链接 ")])),_:1})]),r("div",H,[(u(!0),d(_,null,f(x.value,((e,a)=>(u(),d("div",{key:e.id,class:"channel-info-item"},[r("div",K,g(a+1)+". "+g(e.channel_name),1),r("div",L,g(e.channel_url),1)])))),128))])])])),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-c36664b5"]]);export{B as default};
